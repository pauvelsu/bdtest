services:
  # ---------- ActiveMQ ----------
  activemq:
    image: rmohr/activemq:latest
    restart: always
    ports:
      - "61616:61616"
      - "8161:8161"
    environment:
      - ACTIVEMQ_ADMIN_LOGIN=admin
      - ACTIVEMQ_ADMIN_PASSWORD=admin
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8161"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - search_net

  # ---------- Hazelcast ----------
  hazelcast:
    image: hazelcast/hazelcast:latest
    environment:
      - HZ_CLUSTERNAME=search-cluster
    networks:
      - search_net

  # ---------- Ingestion Service ----------
  ingestion-service:
    build:
      context: ./ingestion-service
      dockerfile: Dockerfile
    environment:
      - BROKER_URL=tcp://activemq:61616
      - INGESTION_QUEUE=document.ingested
    depends_on:
      activemq:
        condition: service_healthy
    ports:
      - "7001:7001"
    networks:
      - search_net
    volumes:
      - ./datalake:/app/datalake

  # ---------- Indexing Service ----------
  indexing-service:
    build:
      context: ./indexing-service
      dockerfile: Dockerfile
    environment:
      - BROKER_URL=tcp://activemq:61616
      - INGESTION_QUEUE=document.ingested
      - DATAMART_DB=/app/datamart/index.db
    volumes:
      - ./datalake:/app/datalake:ro
      - ./datamart:/app/datamart
    depends_on:
      activemq:
        condition: service_healthy
      hazelcast:
        condition: service_started
    ports:
      - "7002:7002"
    networks:
      - search_net

  # ---------- Search Service ----------
  search-service:
    build:
      context: ./search-service
      dockerfile: Dockerfile
    environment:
      - DATAMART_DB=/app/datamart/index.db
    volumes:
      - ./datamart:/app/datamart
    expose:
      - "7003"
    networks:
      - search_net
    depends_on:
      hazelcast:
        condition: service_started

  # ---------- Control Module ----------
  control-service:
    build:
      context: ./control-module
      dockerfile: Dockerfile
    environment:
      - INGESTION_URL=http://ingestion-service:7001
      - INDEXING_URL=http://indexing-service:7002
      - SEARCH_URL=http://search-service:7003
    ports:
      - "7000:7000"
    networks:
      - search_net
    depends_on:
      ingestion-service:
        condition: service_started
      indexing-service:
        condition: service_started
      search-service:
        condition: service_started

  # ---------- Benchmark ----------
  benchmark:
    build:
      context: ./benchmarks
      dockerfile: Dockerfile
    environment:
      - INGESTION_URL=http://ingestion-service:7001
      - INDEXING_URL=http://indexing-service:7002
      - SEARCH_URL=http://search-service:7003
    depends_on:
      control-service:
        condition: service_started
    networks:
      - search_net

  # ---------- NGINX ----------
  nginx:
    image: nginx:latest
    ports:
      - "8080:80"
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - search_net
    depends_on:
      search-service:
        condition: service_started

networks:
  search_net:
    driver: bridge
